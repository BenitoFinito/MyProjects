<!DOCTYPE html>
<html lang="pl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="kebabownia.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/2.0.3/js/dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/2.0.3/css/dataTables.dataTables.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <title>Kebabownia</title>
</head>

<body>
  <div class="tlo"></div>
  <div class="header">
    <div>
      <h1 style="margin: 0"><a href="./">Kebabownia</a></h1>
      <h3 style="margin: 0">Zapisuj swoje ulubione kebabownie</h3>
    </div>
  </div>
  <div class="main">
    <a href="nowy-lokal.html">Dodaj nowy lokal kebabowy</a>
  </div>
  <div class="dane">
    <table id="myTable">
    </table>
  </div>
  <script>
    var urlLocal = "http://localhost/Zadanie15/";
    $(document).ready(function () {
      var gotowe = false;
      $.getJSON("getDane.php", function (data) {
        let dataTable = new DataTable("#myTable", {
          data: data,
          columns: [
            {
              title: "Nazwa",
              data: null,
              render: function (data, type, row) {
                return "<h3>" + data.nazwa + "</h3>";
              }
            },
            {
              title: "Ocena",
              data: null,
              render: function (data, type, row) {
                return '<p><span class="rating">' + data.ocena + "</span>/5</p>";
              }
            },
            {
              title: "Miejsce",
              data: null,
              orderable: false,
              render: function (data, type, row) {
                return '<div id="map-' + data.id + '" class="map"><div id="coordinates" style="display: block;">Szerokość: ' + data.szerokosc + ", Długość: " + data.dlugosc + "</div></div>";
              }
            },
            {
              title: "Opis",
              data: null,
              render: function (data, type, row) {
                return '<p class="opis">' + data.opis + "</p>";
              },
            },
            {
              title: "Akcje",
              data: null,
              render: function (data, type, row) {
                return (
                  '<button class="edit" data-id="' +
                  data.id +
                  '">Edytuj</button>' +
                  '<button class="delete" data-id="' +
                  data.id +
                  '">Usuń</button>'
                );
              },
            },
          ]
        });

        initMaps();

        dataTable.on('draw.dt', function () {
          initMaps();
        });

        function initMaps() {
          dataTable.rows().every(function () {
            var data = this.data();
            var mapId = 'map-' + data.id;
            var mapElement = document.getElementById(mapId);
            if (mapElement && !mapElement.hasAttribute('data-map-initialized')) {
              mapElement.setAttribute('data-map-initialized', 'true');
              var miniMap = L.map(mapId, {
                maxBounds: [
                  [
                    parseFloat(data.szerokosc) - 5,
                    parseFloat(data.dlugosc) - 5,
                  ],
                  [
                    parseFloat(data.szerokosc) + 5,
                    parseFloat(data.dlugosc) + 5,
                  ],
                ],
                maxBoundsViscosity: 1.0,
                minZoom: 2,
              }).setView([data.szerokosc, data.dlugosc], 14);
              L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                attribution:
                  '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
              }).addTo(miniMap);

              miniMap.eachLayer(function (layer) {
                if (layer instanceof L.Marker) {
                  miniMap.removeLayer(layer);
                }
              });

              L.marker([data.szerokosc, data.dlugosc])
                .addTo(miniMap)
                .bindPopup("<b>" + data.nazwa + "</b>");
            }
          });
        }

      });

      $(document).on("click", ".edit", function () {
        var entryId = $(this).data("id");
        Swal.fire({
          title: "Czy na pewno chcesz edytować ten wpis?",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "Tak, edytuj!",
          cancelButtonText: "Anuluj",
        }).then((result) => {
          if (result.isConfirmed) {
            if (result.isConfirmed) {
              window.location.href = "edycja-wpisu.php?id=" + entryId;
            }
          }
        });
      });

      $(document).on("click", ".delete", function () {
        var entryId = $(this).data("id");
        console.log(entryId);
        Swal.fire({
          title: "Czy na pewno chcesz usunąć ten wpis?",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "Tak, usuń!",
          cancelButtonText: "Anuluj",
        }).then((result) => {
          if (result.isConfirmed) {
            $.ajax({
              url: urlLocal + "deleteEntry.php",
              method: "post",
              data: { id: entryId },
              dataType: "json",
              success: function (response) {
                if (response.success === "true") {
                  Swal.fire({
                    icon: "success",
                    title: "Usunięto!",
                    text: "Wpis został pomyślnie usunięty.",
                  }).then((result) => {
                    if (result.isConfirmed) {
                      location.reload();
                    }
                  });
                } else {
                  Swal.fire({
                    icon: "error",
                    title: "Błąd!",
                    text: "Coś poszło nie tak...",
                  });
                }
              },
              error: function (xhr, status, error) {
                Swal.fire({
                  icon: "error",
                  title: "Wystąpił błąd podczas przesyłania danych",
                  html: error,
                });
                console.log(xhr.responseText, status, error);
              },
            });
          }
        });
      });
    });
  </script>
</body>

</html>